"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_Promise="undefined"==typeof Promise?require("es6-promise").Promise:Promise;!function(t){if("undefined"!=typeof define&&define.amd)define(["jquery","socket.io-client","promise-defer"],t);else if("undefined"!=typeof module)module.exports=t(require("jquery"),require("socket.io-client"),require("promise-defer"));else{if("undefined"==typeof window)throw new Error("Unsupported environment");"undefined"!=typeof window.$&&"undefined"!=typeof window.io?window.WisemblyRealTime=t(window.$,window.io):"undefined"!=typeof require&&(window.WisemblyRealTime=t(require("jquery"),require("socket.io-client"),require("promise-defer")))}}(function(t,e,i){var n=arguments,s=this,o=function t(e){e=e||{};for(var i=1;i<n.length;i++){var s=n[i];if(s)for(var o in s)s.hasOwnProperty(o)&&("object"===_typeof(s[o])?e[o]=t(e[o],s[o]):e[o]=s[o])}return e},r=function(t){this.init(t)};return r.version="0.3.0",r.prototype={init:function(t){this.mode=null,this.state="offline",this.states={push:"offline",polling:"offline"},this.__bindings={},this.uuid="------------------------------------",this.promises={},this.rooms=[],this.analytics=[],this.events={},this.entities={},this.options={apiHost:null,apiNamespace:"api/4/",apiToken:null,server:null,reconnection:!0,reconnectionAttempts:1/0,reconnectionDelay:1e3,reconnectionDelayMax:6e4,pullInterval:1e4,pullIntervalEnhance:6e4,forceNew:!0,inactivityTimeout:0,transports:["websocket","polling"]},this.setOptions(t)},setOptions:function(t){if(this.options=Object.assign({},this.options,t),this.options.apiToken&&this.offlineContext){var e=this.offlineContext;this.offlineContext=null,this.join(e)}},connect:function(t){var n=this;switch(this.states.push){case"connected":return _Promise.resolve();case"connecting":return this.getPromise("push:connecting").promise()}var s=i();if(this.setState("push","connecting"),this.storePromise("push:connecting",s),this.socket=e(this.options.server.toString(),this.options),this.bindSocketEvents(),this.options.apiToken){var o=this.offlineContext;this.offlineContext=null,this.join(o)}return s.promise.then(function(){n.trigger("connected",Object.assign({},{states:n.states},t)),n.startActivityMonitor()})},disconnect:function(t){var e=this;if("offline"===this.getState())return _Promise.resolve();if("disconnecting"===this.states.push)return this.getPromise("push:disconnecting").promise;var n=i();return this.socket&&this.socket.connected?(this.setState("push","disconnecting"),this.storePromise("push:disconnecting",n),this.socket.disconnect()):n.promise.resolve(),this.stopPushRejoin(),this.stopPolling(),this.offlineContext=null,n.promise.then(function(){e.setStates({push:"offline",polling:"offline"}),e.socket=null,e.rooms=[],e.analytics=[],e.promises={},e.events={},e.entities={},e.trigger("disconnected",Object.assign({},{states:e.states},t))})},ping:function(){var t=this,e=i();return this.socket.emit("_ping",{timestamp:+new Date},function(i,n){"_pong"!==i?e.promise.reject():(t.trigger("_pong",n),e.promise.resolve(n))}),e.promise},joinFromPush:function(t){var e=this,n=i();return this.socket?this.socket.emit("join",Object.assign({},{token:this.options.apiToken},t),function(i,s,o){o=o||{},"date"in o&&(e.lastPullTime=e.lastPullTime||+new Date(o.date)),i?(console.log("[realtime] Unable to join rooms on the Wisembly websocket server",i,t),e.setState("polling","full"),n.promise.reject(i)):(console.log("[realtime] Successfully joined %d rooms on the Wisembly websocket server",s.length,s),e.setState("polling","medium"),e.rooms=s,e.trigger("rooms",{rooms:e.rooms}),n.promise.resolve(e.rooms))}):n.promise.reject(),n.promise},joinFromAPI:function(t){var e=this,n=i(),s=this.rooms;return this.fetchRooms({data:JSON.stringify(t)}).then(function(t,i,o){t=t.success||t,t=t.data||t;var r=t.rooms;r.forEach(function(t,e){s.includes(t)||s.push(t)}),o.getResponseHeader("Date")&&(e.lastPullTime=e.lastPullTime||+new Date(o.getResponseHeader("Date"))),e.setState("polling","full"),e.resolvePromise("polling:connecting"),console.log("[realtime] Successfully retrieved %d rooms from Wisembly API",s.length,s),e.trigger("rooms",{rooms:s}),n.promise.resolve(s)}).catch(n.promise.reject),n.promise},join:function(t){var e=this,n=i();if(this.options.apiToken)switch(this.getState()){case"push:connected":this.joinFromPush(t).then(n.promise.resolve).catch(function(){e.joinFromAPI(t).then(n.promise.resolve).catch(n.promise.reject).then(function(){e.startPushRejoin(0)})});break;case"push:connecting":this.getPromise("push:connecting").then(function(){e.join(t).then(n.promise.resolve).catch(n.promise.reject)});break;case"polling:connecting":case"polling:full":this.joinFromAPI(t).then(n.promise.resolve).catch(n.promise.reject);break;default:this.offlineContext=Object.assign({},this.offlineContext,t),n.promise.reject()}else this.offlineContext=Object.assign({},this.offlineContext,t),n.reject();return n.promise},leave:function(t){return dfd.promise.reject()},addAnalytics:function(t){var e=this;t=!t||Array.isArray(t)?t:[t];var n=i();switch(this.getState()){case"push:connected":this.socket.emit("analytics:subscribe",t||[],function(t,i){t?n.promise.reject(t):(console.log("[realtime] Successfully joined %d analytics rooms on the Wisembly websocket server",i.length),e.analytics=i,n.promise.resolve(e.analytics))});break;default:t.length&&t.forEach(function(t,i){e.analytics.includes(t)||e.analytics.push(t)}),n.promise.resolve(this.analytics)}return n.promise},removeAnalytics:function(t){return dfd.promise.reject()},addEvent:function(t){this.events[t.hash]=!0},checkEvent:function(t){return!this.events.hasOwnProperty(t.hash)},handleEvent:function(t){return!(!this.checkEvent(t)||!this.checkEntity(t))&&(this.addEvent(t),this.addEntity(t),this.sendEvent(t),!0)},sendEvent:function(t){this.startActivityMonitor(),this.trigger("event",t)},startActivityMonitor:function(){var t=this;this.options.inactivityTimeout&&(clearTimeout(this.inactivityTimer),this.inactivityTimer=setTimeout(function(){t.trigger("inactivity",{timeout:t.options.inactivityTimeout})},this.options.inactivityTimeout))},stopActivityMonitor:function(){clearTimeout(this.inactivityTimer),this.inactivityTimer=null},addEntity:function(t){var e=t.data||{},i=e.class_name,n=e.id||e.hash,s=i&&n?i+":"+n:null,o=t.time;s&&o&&(this.entities[s]=o)},checkEntity:function(t){var e=t.data||{},i=e.class_name,n=e.id||e.hash,s=i&&n?i+":"+n:null,o=t.time;return!s||!o||!this.entities.hasOwnProperty(s)||o>=this.entities[s]},startPushRejoin:function(t){function e(t){var e=this,s=this.rooms.length?this.joinFromPush({rooms:this.rooms}):_Promise.resolve();return s.then(function(){e.addAnalytics(e.analytics)}).catch(function(){++n<e.options.reconnectionAttempts&&i(t+e.options.reconnectionDelay)}),s}function i(t){"connected"===this.states.push&&(t=Math.min(t||0,this.options.reconnectionDelayMax),clearTimeout(this.pushRejoinTimer),this.pushRejoinTimer=setTimeout(function(){e(t)},t))}if("connected"===this.states.push){var n=0;clearTimeout(this.pushRejoinTimer),i(t)}},stopPushRejoin:function(){clearTimeout(this.pushRejoinTimer),this.pushRejoinTimer=null},getPushTransport:function(){return"connected"!==this.states.push?null:this.socket.io.engine.transport.ws?"websocket":"polling"},startPolling:function(){function t(){return this.pull().then(e)}function e(){switch(clearTimeout(this.pullTimer),this.states.polling){case"full":this.pullTimer=setTimeout(t,this.options.pullInterval);break;case"medium":this.pullTimer=setTimeout(t,this.options.pullIntervalEnhance)}}"offline"!==this.states.polling&&(clearTimeout(this.pullTimer),t())},stopPolling:function(){clearTimeout(this.pullTimer),this.pullTimer=null,this.setState("polling","offline")},pull:function(){var t=this;return this.pullXHR?this.pullXHR:(this.pullXHR=this.fetchPullEvents(),this.pullXHR.then(function(e){e=e.success||e,e=e.data||e,e.data&&e.data.length&&e.data.forEach(function(e,i){t.handleEvent(Object.assign({},e,{via:"polling"}))&&"full"!==t.states.polling&&t.trigger("missed",e)}),t.lastPullTime=e.since>(t.lastPullTime||0)?e.since:t.lastPullTime}).then(function(){t.pullXHR=null}))},bindSocketEvents:function(){var t=this,e=arguments;this.socket.on("broadcast",function(){t.onSocketBroadcast.apply(t,e)}),this.socket.on("uuid",function(){console.log("[realtime] Your unique connection ID is: "+data.uuid),t.onSocketUuid.apply(t,e)}),this.socket.on("connect",function(){console.log("[realtime] Welcome to the Wisembly websocket server"),t.onSocketConnect.apply(t,e)}),this.socket.on("connect_error",function(){console.log("[realtime] Cannot connect to websocket server"),t.onSocketConnectError.apply(t,e)}),this.socket.on("disconnect",function(){console.log("[realtime] Disconnected from the Wisembly websocket server"),t.onSocketDisconnect.apply(t,e)}),this.socket.on("reconnecting",function(){console.log("[realtime] Reconnecting to the Wisembly websocket server"),t.onSocketReconnecting.apply(t,e)}),this.socket.on("reconnect",function(){console.log("[realtime] Reconnected to the Wisembly websocket server"),t.onSocketReconnect.apply(t,e)}),this.socket.on("analytics",function(i){i=i||{},t.onSocketAnalytics.apply(t,e)})},onSocketBroadcast:function(t){var e=JSON.parse(t);this.handleEvent(Object.assign({},e,{via:"socket"}))},onSocketConnect:function(){this.trigger("pushUp"),this.setStates({push:"connected",polling:"medium"}),this.resolvePromise("push:connecting")},onSocketUuid:function(t){this.uuid=t.uuid},onSocketConnectError:function(t){this.onSocketDisconnect(t),this.resolvePromise("push:connecting")},onSocketDisconnect:function(t){var e=this;this.trigger("pushDown"),this.resolvePromise("push:disconnecting").catch(function(){e.setStates({push:"offline",polling:"full"})})},onSocketReconnecting:function(){this.setState("push","connecting")},onSocketReconnect:function(){this.onSocketConnect()},onSocketAnalytics:function(t){this.trigger("analytics",t)},buildURL:function(t){if(!this.options.apiHost||!this.options.apiNamespace)return null;var e=this.options.apiHost.toString()+"/"+this.options.apiNamespace.toString()+"/"+t;return e.replace(/([^:]\/)\//g,function(t,e){return e})},apiRequest:function(t,e){var i=s.options.apiToken,n=s.buildURL(t);return e=o({url:n,type:"GET",dataType:"json",contentType:"application/json",headers:{"Wisembly-Token":i},cache:!1},e),new _Promise(function(o,r){n&&i||r(Error("No URL or token"));var c=new XMLHttpRequest,l=Object.assign({"Content-Type":e.contentType,"Cache-Control":e.cache?e.cache:"max-age=0"},e.headers);c.open(e.type,e.url,!0);for(key in l)c.setRequestHeader(header,l[key]);c.responseType(e.dataType),c.onreadystatechange=function(){if(200==c.status)o(c.response);else{var n=JSON.parse(c.response),l=n.error&&n.error.message,a=Object.assign({request:Object.assign({},{path:t,token:i},e)},l?l:{});s.trigger("error",a),r(Error(c.statusText))}},c.onerror=function(){s.trigger("error"),r(Error("Network error"))},c.ontimeout=function(){s.trigger("error"),r(Error("Timeout"))},"GET"===e.get?c.send():c.send(e.data)})},fetchRooms:function(t){return this.apiRequest("users/node/credentials",Object.assign({},{type:"POST"},t))},fetchPullEvents:function(t){return this.apiRequest("pull",{type:"GET",data:{rooms:this.rooms,since:this.lastPullTime,enhanced:"full"!==this.states.polling}})},storePromise:function(t,e){return this.promises[t]=e},getPromise:function(e){return this.promises[e]||t.Deferred().reject()},resolvePromise:function(t){var e=this,i=this.getPromise(t);return"pending"===i.state()&&i.promise.resolve(),i.promise.then(function(){delete e.promises[t]})},setStates:function(t){if(t.push!==this.states.push||t.polling!==this.states.polling){var e=this.states;this.states=t;var i=this.getState();if(this.state!==i){var n=this.state;this.state=i,this.trigger("state",{state:i,previous:n})}e.polling!==this.states.polling&&this.startPolling(),e.push!==this.states.push&&this.startPushRejoin(0)}},setState:function(t,e){var i={push:this.states.push,polling:this.states.polling};i[t]=e,this.setStates(i)},getState:function(){switch(this.states.polling){case"full":case"connecting":return"polling:"+this.states.polling}switch(this.states.push){case"connected":case"connecting":return"push:"+this.states.push}return"offline"},on:function(t,e,i,n){null===i&&(i=void 0),this.__bindings.hasOwnProperty(t)||(this.__bindings[t]=[]),this.__bindings[t]=this.__bindings[t].concat([{handler:e,context:i,once:Boolean(n)}])},off:function(t,e,i){if(null===i&&(i=void 0),this.__bindings.hasOwnProperty(t)){for(var n=[],s=0,o=this.__bindings[t].length;s<o;++s)this.__bindings[t][s].handler===e&&this.__bindings[t][s].context===i||n.push(this.__bindings[t][s]);this.__bindings[t]=filteredListeners}},once:function(t,e,i){this.on(t,e,i,!0)},trigger:function(t){if(this.__bindings.hasOwnProperty(t)){for(var e=[],i=1,n=arguments.length;i<n;++i)e.push(arguments[i]);for(var s=this.__bindings[t],o=0,r=s.length;o<r;++o)s[o].once&&this.off(t,s[o].handler,s[o].context);for(var c=0,l=s.length;c<l;++c)s[c].handler.apply(s[c].context,args)}}},r});