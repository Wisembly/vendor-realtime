!function(t){if("undefined"!=typeof define&&define.amd)define(["jquery","socket.io-client"],t);else if("undefined"!=typeof module)module.exports=t(require("jquery"),require("socket.io-client"));else{if("undefined"==typeof window)throw new Error("Unsupported environment");void 0!==window.$&&void 0!==window.io?window.WisemblyRealTime=t(window.$,window.io):"undefined"!=typeof require&&(window.WisemblyRealTime=t(require("jquery"),require("socket.io-client")))}}(function(l,s){function t(t){this.init(t)}return t.version="0.3.0",t.prototype={init:function(t){this.mode=null,this.io=s,this.state="offline",this.states={push:"offline",polling:"offline"},this.__bindings={},this.uuid="------------------------------------",this.promises={},this.rooms=[],this.analytics=[],this.events={},this.entities={},this.options={apiHost:null,apiNamespace:"api/4/",apiToken:null,server:null,reconnection:!0,reconnectionAttempts:1/0,reconnectionDelay:1e3,reconnectionDelayMax:6e4,pullInterval:1e4,pullIntervalEnhance:6e4,forceNew:!0,inactivityTimeout:0,transports:["websocket","polling"]},this.setOptions(t)},setOptions:function(t){var e;this.options=l.extend({},this.options,t),this.options.apiToken&&this.offlineContext&&(e=this.offlineContext,this.offlineContext=null,this.join(e))},setOption:function(t,e){this.options[t]=e},connect:function(t){switch(this.states.push){case"connected":return l.Deferred().resolve().promise();case"connecting":return this.getPromise("push:connecting").promise()}var e,n=this,i=l.Deferred();return this.setState("push","connecting"),this.storePromise("push:connecting",i),this.socket=s(this.options.server.toString(),this.options),this.bindSocketEvents(),this.options.apiToken&&(e=this.offlineContext,this.offlineContext=null,this.join(e)),i.promise().done(function(){n.trigger("connected",l.extend({states:n.states},t)),n.startActivityMonitor()})},disconnect:function(t){if("offline"===this.getState())return l.Deferred().resolve().promise();if("disconnecting"===this.states.push)return this.getPromise("push:disconnecting").promise();var e=this,n=l.Deferred();return this.socket&&this.socket.connected?(this.setState("push","disconnecting"),this.storePromise("push:disconnecting",n),this.socket.disconnect()):n.resolve(),this.stopPushRejoin(),this.stopPolling(),this.offlineContext=null,n.promise().always(function(){e.setStates({push:"offline",polling:"offline"}),e.socket=null,e.rooms=[],e.analytics=[],e.promises={},e.events={},e.entities={},e.trigger("disconnected",l.extend({states:e.states},t))})},ping:function(){var n=this,i=l.Deferred();return this.socket.emit("_ping",{timestamp:+new Date},function(t,e){"_pong"!==t?i.reject():(n.trigger("_pong",e),i.resolve(e))}),i.promise()},joinFromPush:function(i){var s=this,o=l.Deferred();return this.socket?this.socket.emit("join",l.extend({token:this.options.apiToken},i),function(t,e,n){"date"in(n=n||{})&&(s.lastPullTime=s.lastPullTime||+new Date(n.date)),"function"==typeof s.options.onJoin&&s.options.onJoin(t,e,n),t?(console.log("[realtime] Unable to join rooms on the Wisembly websocket server",t,i),s.setState("polling","full"),o.reject(t)):(console.log("[realtime] Successfully joined %d rooms on the Wisembly websocket server",e.length,e),s.setState("polling","medium"),s.rooms=e,s.trigger("rooms",{rooms:s.rooms}),o.resolve(s.rooms))}):o.reject(),o.promise()},joinFromAPI:function(t){var i=this,s=l.Deferred();return this.fetchRooms({data:JSON.stringify(t)}).done(function(t,e,n){t=(t=t.success||t).data||t,l.each(t.rooms,function(t,e){-1===l.inArray(e,i.rooms)&&i.rooms.push(e)}),n.getResponseHeader("Date")&&(i.lastPullTime=i.lastPullTime||+new Date(n.getResponseHeader("Date"))),i.setState("polling","full"),i.resolvePromise("polling:connecting"),console.log("[realtime] Successfully retrieved %d rooms from Wisembly API",i.rooms.length,i.rooms),i.trigger("rooms",{rooms:i.rooms}),s.resolve(i.rooms)}).fail(s.reject),s.promise()},join:function(t){var e=this,n=l.Deferred();if(this.options.apiToken)switch(this.getState()){case"push:connected":this.joinFromPush(t).done(n.resolve).fail(function(){e.joinFromAPI(t).done(n.resolve).fail(n.reject).always(function(){e.startPushRejoin(0)})});break;case"push:connecting":this.getPromise("push:connecting").done(function(){e.join(t).done(n.resolve).fail(n.reject)});break;case"polling:connecting":case"polling:full":this.joinFromAPI(t).done(n.resolve).fail(n.reject);break;default:this.offlineContext=l.extend({},this.offlineContext,t),n.reject()}else this.offlineContext=l.extend({},this.offlineContext,t),n.reject();return n.promise()},leave:function(t){return l.Deferred().reject().promise()},addAnalytics:function(t){t=!t||l.isArray(t)?t:[t];var n=this,i=l.Deferred();switch(this.getState()){case"push:connected":this.socket.emit("analytics:subscribe",t||[],function(t,e){t?i.reject(t):(console.log("[realtime] Successfully joined %d analytics rooms on the Wisembly websocket server",e.length),n.analytics=e,i.resolve(n.analytics))});break;default:l.each(t||[],function(t,e){-1===l.inArray(e,n.analytics)&&n.analytics.push(e)}),i.resolve(this.analytics)}return i.promise()},removeAnalytics:function(t){return l.Deferred().reject().promise()},addEvent:function(t){this.events[t.hash]=!0},checkEvent:function(t){return!this.events.hasOwnProperty(t.hash)},handleEvent:function(t){return!(!this.checkEvent(t)&&t.data||!this.checkEntity(t))&&(this.addEvent(t),this.addEntity(t),this.sendEvent(t),!0)},sendEvent:function(t){this.startActivityMonitor(),this.trigger("event",t)},startActivityMonitor:function(){var t;this.options.inactivityTimeout&&(t=this,clearTimeout(this.inactivityTimer),this.inactivityTimer=setTimeout(function(){t.trigger("inactivity",{timeout:t.options.inactivityTimeout})},this.options.inactivityTimeout))},stopActivityMonitor:function(){clearTimeout(this.inactivityTimer),this.inactivityTimer=null},addEntity:function(t){var e=t.data||{},n=e.class_name,i=e.id||e.hash,s=n&&i?n+":"+i:null,o=t.time;s&&o&&(this.entities[s]=o)},checkEntity:function(t){var e=t.data||{},n=e.class_name,i=e.id||e.hash,s=n&&i?n+":"+i:null,o=t.time;return!s||!o||!this.entities.hasOwnProperty(s)||o>=this.entities[s]},startPushRejoin:function(t){var n;function i(e){"connected"===n.states.push&&(e=Math.min(e||0,n.options.reconnectionDelayMax),clearTimeout(n.pushRejoinTimer),n.pushRejoinTimer=setTimeout(function(){var t;t=e,(n.rooms.length?n.joinFromPush({rooms:n.rooms}):l.Deferred().resolve().promise()).done(function(){n.addAnalytics(n.analytics)}).fail(function(){++nbAttemps<n.options.reconnectionAttempts&&i(t+n.options.reconnectionDelay)})},e))}"connected"===this.states.push&&(n=this,nbAttemps=0,clearTimeout(this.pushRejoinTimer),i(t))},stopPushRejoin:function(){clearTimeout(this.pushRejoinTimer),this.pushRejoinTimer=null},getPushTransport:function(){return"connected"!==this.states.push?null:this.socket.io.engine.transport.ws?"websocket":"polling"},startPolling:function(){var t;function e(){return t.pull().always(n)}function n(){switch(clearTimeout(t.pullTimer),t.states.polling){case"full":t.pullTimer=setTimeout(e,t.options.pullInterval);break;case"medium":t.pullTimer=setTimeout(e,t.options.pullIntervalEnhance)}}"offline"!==this.states.polling&&(t=this,clearTimeout(this.pullTimer),e())},stopPolling:function(){clearTimeout(this.pullTimer),this.pullTimer=null,this.setState("polling","offline")},pull:function(){if(this.pullXHR)return this.pullXHR;var n=this;return this.pullXHR=this.fetchPullEvents(),this.pullXHR.done(function(t){t=(t=t.success||t).data||t,l.each(t.data||[],function(t,e){n.handleEvent(l.extend({},e,{via:"polling"}))&&"full"!==n.states.polling&&n.trigger("missed",e)}),n.lastPullTime=t.since>(n.lastPullTime||0)?t.since:n.lastPullTime}).always(function(){n.pullXHR=null})},bindSocketEvents:function(){var e=this;this.socket.on("broadcast",function(){e.onSocketBroadcast.apply(e,arguments)}),this.socket.on("uuid",function(t){console.log("[realtime] Your unique connection ID is: "+t.uuid),e.onSocketUuid.apply(e,arguments)}),this.socket.on("cluster",function(t){console.log("[realtime] Your cluster node is: "+t.node),e.onSocketCluster.apply(e,arguments)}),this.socket.on("connect",function(){console.log("[realtime] Welcome to the Wisembly websocket server"),e.onSocketConnect.apply(e,arguments)}),this.socket.on("connect_error",function(){console.log("[realtime] Cannot connect to websocket server"),e.onSocketConnectError.apply(e,arguments)}),this.socket.on("disconnect",function(){console.log("[realtime] Disconnected from the Wisembly websocket server"),e.onSocketDisconnect.apply(e,arguments)}),this.socket.on("reconnecting",function(){console.log("[realtime] Reconnecting to the Wisembly websocket server"),e.onSocketReconnecting.apply(e,arguments)}),this.socket.on("reconnect",function(){console.log("[realtime] Reconnected to the Wisembly websocket server"),e.onSocketReconnect.apply(e,arguments)}),this.socket.on("analytics",function(t){t=t||{},e.onSocketAnalytics.apply(e,arguments)})},onSocketBroadcast:function(t){"string"==typeof t&&(t=JSON.parse(t)),this.handleEvent(l.extend({},t,{via:"socket"}))},onSocketConnect:function(){this.trigger("pushUp"),this.setStates({push:"connected",polling:"medium"}),this.resolvePromise("push:connecting")},onSocketUuid:function(t){this.uuid=t.uuid},onSocketCluster:function(t){this.cluster=t.cluster},onSocketConnectError:function(t){this.onSocketDisconnect(t),this.resolvePromise("push:connecting")},onSocketDisconnect:function(t){var e=this;this.trigger("pushDown"),this.resolvePromise("push:disconnecting").fail(function(){e.setStates({push:"offline",polling:"full"})})},onSocketReconnecting:function(){this.setState("push","connecting")},onSocketReconnect:function(){this.onSocketConnect()},onSocketAnalytics:function(t){this.trigger("analytics",t)},buildURL:function(t){return this.options.apiHost&&this.options.apiNamespace?(this.options.apiHost.toString()+"/"+this.options.apiNamespace.toString()+"/"+t).replace(/([^:]\/)\//g,function(t,e){return e}):null},apiRequest:function(s,o){var r=this,c=this.options.apiToken,t=this.options.password,e=this.buildURL(s);return e&&c?(o=l.extend(!0,{url:e,type:"GET",dataType:"json",contentType:"application/json",headers:{"Wisembly-Token":c,"Wisembly-Password":t},cache:!1},o),l.ajax(o).fail(function(t,e,n){var i={request:l.extend({path:s,token:c},o)};try{i=l.extend(i,t?l.parseJSON(t.responseText):{})}catch(t){}r.trigger("error",i)})):l.Deferred().reject().promise()},fetchRooms:function(t){return this.apiRequest("users/node/credentials",l.extend({type:"POST"},t))},fetchPullEvents:function(t){return this.apiRequest("pull",{type:"GET",data:{rooms:this.rooms,since:this.lastPullTime,enhanced:"full"!==this.states.polling}})},storePromise:function(t,e){return this.promises[t]=e},getPromise:function(t){return this.promises[t]||l.Deferred().reject()},resolvePromise:function(t){var e=this,n=this.getPromise(t);return"pending"===n.state()&&n.resolve(),n.promise().always(function(){delete e.promises[t]})},setStates:function(t){var e,n,i;t.push===this.states.push&&t.polling===this.states.polling||(e=this.states,this.states=t,n=this.getState(),this.state!==n&&(i=this.state,this.state=n,this.trigger("state",{state:n,previous:i})),e.polling!==this.states.polling&&this.startPolling(),e.push!==this.states.push&&this.startPushRejoin(0))},setState:function(t,e){var n={push:this.states.push,polling:this.states.polling};n[t]=e,this.setStates(n)},getState:function(){switch(this.states.polling){case"full":case"connecting":return"polling:"+this.states.polling}switch(this.states.push){case"connected":case"connecting":return"push:"+this.states.push}return"offline"},on:function(t,e,n,i){null===n&&(n=void 0),this.__bindings.hasOwnProperty(t)||(this.__bindings[t]=[]),this.__bindings[t]=this.__bindings[t].concat([{handler:e,context:n,once:Boolean(i)}])},off:function(t,e,n){if(null===n&&(n=void 0),this.__bindings.hasOwnProperty(t)){for(var i=[],s=0,o=this.__bindings[t].length;s<o;++s)this.__bindings[t][s].handler===e&&this.__bindings[t][s].context===n||i.push(this.__bindings[t][s]);this.__bindings[t]=i}},once:function(t,e,n){this.on(t,e,n,!0)},trigger:function(t){if(this.__bindings.hasOwnProperty(t)){for(var e=[],n=1,i=arguments.length;n<i;++n)e.push(arguments[n]);for(var s=this.__bindings[t],n=0,i=s.length;n<i;++n)s[n].once&&this.off(t,s[n].handler,s[n].context);for(n=0,i=s.length;n<i;++n)s[n].handler.apply(s[n].context,e)}}},t});