!function(t){if("undefined"!=typeof define&&define.amd)define(["jquery","socket.io-client"],t);else if("undefined"!=typeof require)module.exports=t(require("jquery"),require("socket.io-client"));else{if("undefined"==typeof window)throw new Error("Unsupported environment");window.WisemblyRealTime=t(window.$,window.io)}}(function(t,e){var n=function(t){this.init(t)};return n.version="0.3.0",n.prototype={init:function(t){this.mode=null,this.state="offline",this.states={push:"offline",polling:"offline"},this.__bindings={},this.promises={},this.rooms=[],this.analytics=[],this.events={},this.entities={},this.options={apiHost:null,apiNamespace:"api/4/",apiToken:null,server:null,reconnection:!0,reconnectionAttempts:1/0,reconnectionDelay:1e3,reconnectionDelayMax:6e4,pullInterval:1e4,pullIntervalEnhance:6e4,forceNew:!0,inactivityTimeout:0},this.setOptions(t)},setOptions:function(e){if(this.options=t.extend({},this.options,e),this.options.apiToken&&this.offlineContext){var n=this.offlineContext;this.offlineContext=null,this.join(n)}},connect:function(n){switch(this.states.push){case"connected":return t.Deferred().resolve().promise();case"connecting":return this.getPromise("push:connecting").promise()}var i=this,s=t.Deferred();if(this.setState("push","connecting"),this.storePromise("push:connecting",s),this.socket=e(this.options.server.toString(),this.options),this.bindSocketEvents(),this.options.apiToken){var o=this.offlineContext;this.offlineContext=null,this.join(o)}return s.promise().done(function(){i.trigger("connected",t.extend({states:i.states},n)),i.startActivityMonitor()})},disconnect:function(e){if("offline"===this.getState())return t.Deferred().resolve().promise();if("disconnecting"===this.states.push)return this.getPromise("push:disconnecting").promise();var n=this,i=t.Deferred();return this.socket&&this.socket.connected?(this.setState("push","disconnecting"),this.storePromise("push:disconnecting",i),this.socket.disconnect()):i.resolve(),this.stopPushRejoin(),this.stopPolling(),this.offlineContext=null,i.promise().always(function(){n.setStates({push:"offline",polling:"offline"}),n.socket=null,n.rooms=[],n.analytics=[],n.promises={},n.trigger("disconnected",t.extend({states:this.states},e))})},ping:function(){var e=this,n=t.Deferred();return this.socket.emit("ping",{timestamp:+new Date},function(t,i){"pong"!==t?n.reject():(e.trigger("pong",i),n.resolve(i))}),n.promise()},joinFromPush:function(e){var n=this,i=t.Deferred();return this.socket?this.socket.emit("join",t.extend({token:this.options.apiToken},e),function(t,s,o){o=o||{},"date"in o&&(n.lastPullTime=n.lastPullTime||+new Date(o.date)),t?(console.log("[realtime] Unable to join rooms on the Wisembly websocket server",t,e),n.setState("polling","full"),i.reject(t)):(console.log("[realtime] Successfully joined %d rooms on the Wisembly websocket server",s.length,s),n.setState("polling","medium"),n.rooms=s,n.trigger("rooms",{rooms:n.rooms}),i.resolve(n.rooms))}):i.reject(),i.promise()},joinFromAPI:function(e){var n=this,i=t.Deferred();return this.fetchRooms({data:JSON.stringify(e)}).done(function(e,s,o){e=e.success||e,e=e.data||e,t.each(e.rooms,function(e,i){t.inArray(i,n.rooms)===-1&&n.rooms.push(i)}),o.getResponseHeader("Date")&&(n.lastPullTime=n.lastPullTime||+new Date(o.getResponseHeader("Date"))),n.setState("polling","full"),n.resolvePromise("polling:connecting"),console.log("[realtime] Successfully retrieved %d rooms from Wisembly API",n.rooms.length,n.rooms),n.trigger("rooms",{rooms:n.rooms}),i.resolve(n.rooms)}).fail(i.reject),i.promise()},join:function(e){var n=this,i=t.Deferred();if(this.options.apiToken)switch(this.getState()){case"push:connected":this.joinFromPush(e).done(i.resolve).fail(function(){n.joinFromAPI(e).done(i.resolve).fail(i.reject).always(function(){n.startPushRejoin(0)})});break;case"push:connecting":this.getPromise("push:connecting").done(function(){n.join(e).done(i.resolve).fail(i.reject)});break;case"polling:connecting":case"polling:full":this.joinFromAPI(e).done(i.resolve).fail(i.reject);break;default:this.offlineContext=t.extend({},this.offlineContext,e),i.reject()}else this.offlineContext=t.extend({},this.offlineContext,e),i.reject();return i.promise()},leave:function(e){return t.Deferred().reject().promise()},addAnalytics:function(e){e=!e||t.isArray(e)?e:[e];var n=this,i=t.Deferred();switch(this.getState()){case"push:connected":this.socket.emit("analytics:subscribe",e||[],function(t,e){t?i.reject(t):(console.log("[realtime] Successfully joined %d analytics rooms on the Wisembly websocket server",e.length),n.analytics=e,i.resolve(n.analytics))});break;default:t.each(e||[],function(e,i){t.inArray(i,n.analytics)===-1&&n.analytics.push(i)}),i.resolve(this.analytics)}return i.promise()},removeAnalytics:function(e){return t.Deferred().reject().promise()},addEvent:function(t){this.events[t.hash]=!0},removeEvents:function(){this.events={}},checkEvent:function(t){return!this.events.hasOwnProperty(t.hash)},handleEvent:function(t){return!(!this.checkEvent(t)||!this.checkEntity(t))&&(this.addEvent(t),this.addEntity(t),this.sendEvent(t),!0)},sendEvent:function(t){this.startActivityMonitor(),this.trigger("event",t)},startActivityMonitor:function(){if(this.options.inactivityTimeout){var t=this;clearTimeout(this.inactivityTimer),this.inactivityTimer=setTimeout(function(){t.trigger("inactivity",{timeout:t.options.inactivityTimeout})},this.options.inactivityTimeout)}},stopActivityMonitor:function(){clearTimeout(this.inactivityTimer),this.inactivityTimer=null},addEntity:function(t){var e=t.data||{},n=e.class_name,i=e.id||e.hash,s=n&&i?n+":"+i:null,o=t.time;s&&o&&(this.entities[s]=o)},checkEntity:function(t){var e=t.data||{},n=e.class_name,i=e.id||e.hash,s=n&&i?n+":"+i:null,o=t.time;return!s||!o||!this.entities.hasOwnProperty(s)||o>=this.entities[s]},startPushRejoin:function(e){function n(e){var n=s.rooms.length?s.joinFromPush({rooms:s.rooms}):t.Deferred().resolve().promise();return n.done(function(){s.addAnalytics(s.analytics)}).fail(function(){++nbAttemps<s.options.reconnectionAttempts&&i(e+s.options.reconnectionDelay)}),n}function i(t){"connected"===s.states.push&&(t=Math.min(t||0,s.options.reconnectionDelayMax),s.pushRejoinTimer=setTimeout(function(){n(t)},t))}if("connected"===this.states.push){var s=this;nbAttemps=0,clearTimeout(this.pushRejoinTimer),i(e)}},stopPushRejoin:function(){clearTimeout(this.pushRejoinTimer),this.pushRejoinTimer=null},startPolling:function(){function t(){return n.pull().always(e)}function e(){switch(n.states.polling){case"full":n.pullTimer=setTimeout(t,n.options.pullInterval);break;case"medium":n.pullTimer=setTimeout(t,n.options.pullIntervalEnhance)}}if("offline"!==this.states.polling){var n=this;clearTimeout(this.pullTimer),t()}},stopPolling:function(){clearTimeout(this.pullTimer),this.pullTimer=null,this.setState("polling","offline")},pull:function(){if(this.pullXHR)return this.pullXHR;var e=this;return this.pullXHR=this.fetchPullEvents(),this.pullXHR.done(function(n){n=n.success||n,n=n.data||n;var i=0,s=0;switch(t.each(n.data||[],function(o,r){e.handleEvent(t.extend({},r,{via:"polling"}))&&(s+=n.since-r.time,i+=1)}),e.getState()){case"polling:full":i&&e.trigger("pullReport",i);break;case"push:connected":case"push:connecting":i&&(console.warn("[realtime] missed_push_event:"+i+": on "+n.data.length+" events"),e.trigger("pushMissedReport",i,s/i))}e.lastPullTime=n.since>(e.lastPullTime||0)?n.since:e.lastPullTime}).always(function(){e.pullXHR=null})},bindSocketEvents:function(){var t=this;this.socket.on("broadcast",function(){t.onSocketBroadcast.apply(t,arguments)}),this.socket.on("connect",function(){console.log("[realtime] Welcome to the Wisembly websocket server"),t.onSocketConnect.apply(t,arguments)}),this.socket.on("connect_error",function(){console.log("[realtime] Cannot connect to websocket server"),t.onSocketConnectError.apply(t,arguments)}),this.socket.on("disconnect",function(){console.log("[realtime] Disconnected from the Wisembly websocket server"),t.onSocketDisconnect.apply(t,arguments)}),this.socket.on("reconnecting",function(){console.log("[realtime] Reconnecting to the Wisembly websocket server"),t.onSocketReconnecting.apply(t,arguments)}),this.socket.on("reconnect",function(){console.log("[realtime] Reconnected to the Wisembly websocket server"),t.onSocketReconnect.apply(t,arguments)}),this.socket.on("analytics",function(e){e=e||{},t.onSocketAnalytics.apply(t,arguments)})},onSocketBroadcast:function(e){var e=JSON.parse(e);this.handleEvent(t.extend({},e,{via:"socket"}))},onSocketConnect:function(){this.trigger("pushUp"),this.setStates({push:"connected",polling:"medium"}),this.resolvePromise("push:connecting")},onSocketConnectError:function(t){this.onSocketDisconnect(t),this.resolvePromise("push:connecting")},onSocketDisconnect:function(t){var e=this;this.trigger("pushDown"),this.resolvePromise("push:disconnecting").fail(function(){e.setStates({push:"offline",polling:"full"})})},onSocketReconnecting:function(){this.setState("push","connecting")},onSocketReconnect:function(){this.onSocketConnect()},onSocketAnalytics:function(t){this.trigger("analytics",t)},buildURL:function(t){if(!this.options.apiHost||!this.options.apiNamespace)return null;var e=this.options.apiHost.toString()+"/"+this.options.apiNamespace.toString()+"/"+t;return e.replace(/([^:]\/)\//g,function(t,e){return e})},apiRequest:function(e,n){var i=this,s=this.options.apiToken,o=this.buildURL(e);return o&&s?(n=t.extend(!0,{url:o,type:"GET",dataType:"json",contentType:"application/json",headers:{"Wisembly-Token":s},cache:!1},n),t.ajax(n).fail(function(o,r,c){var l={request:t.extend({path:e,token:s},n)};try{l=t.extend(l,o?t.parseJSON(o.responseText):{})}catch(t){}i.trigger("error",l)})):t.Deferred().reject().promise()},fetchRooms:function(e){return this.apiRequest("users/node/credentials",t.extend({type:"POST"},e))},fetchPullEvents:function(t){return this.apiRequest("pull",{type:"GET",data:{rooms:this.rooms,since:this.lastPullTime,enhanced:"full"!==this.states.polling}})},storePromise:function(t,e){return this.promises[t]=e},getPromise:function(e){return this.promises[e]||t.Deferred().reject()},resolvePromise:function(t){var e=this,n=this.getPromise(t);return"pending"===n.state()&&n.resolve(),n.promise().always(function(){delete e.promises[t]})},setStates:function(t){if(t.push!==this.states.push||t.polling!==this.states.polling){var e=this.states;this.states=t;var n=this.getState();this.state!==n&&(this.state=n,this.trigger("state",{state:n})),e.polling!==this.states.polling&&this.startPolling(),e.push!==this.states.push&&this.startPushRejoin(0)}},setState:function(t,e){var n={push:this.states.push,polling:this.states.polling};n[t]=e,this.setStates(n)},getState:function(){switch(this.states.polling){case"full":case"connecting":return"polling:"+this.states.polling}switch(this.states.push){case"connected":case"connecting":return"push:"+this.states.push}return"offline"},on:function(t,e,n,i){null===n&&(n=void 0),this.__bindings.hasOwnProperty(t)||(this.__bindings[t]=[]),this.__bindings[t]=this.__bindings[t].concat([{handler:e,context:n,once:Boolean(i)}])},off:function(t,e,n){if(null===n&&(n=void 0),this.__bindings.hasOwnProperty(t)){for(var i=[],s=0,o=this.__bindings[t].length;s<o;++s)this.__bindings[t][s].handler===e&&this.__bindings[t][s].context===n||i.push(this.__bindings[t][s]);this.__bindings[t]=i}},once:function(t,e,n){this.on(t,e,n,!0)},trigger:function(t){if(this.__bindings.hasOwnProperty(t)){for(var e=[],n=1,i=arguments.length;n<i;++n)e.push(arguments[n]);for(var s=this.__bindings[t],n=0,i=s.length;n<i;++n)s[n].once&&this.off(t,s[n].handler,s[n].context);for(var n=0,i=s.length;n<i;++n)s[n].handler.apply(s[n].context,e)}}},n});