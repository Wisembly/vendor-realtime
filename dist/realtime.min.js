!function(e){window.WisemblyRealTime=function(e){this.init(e)},window.WisemblyRealTime.version="0.1.3",window.WisemblyRealTime.prototype={init:function(e){this.mode=null,this.state="offline",this.states={push:"offline",polling:"offline"},this.__bindings={},this.promises={},this.rooms=[],this.analytics=[],this.events={},this.entities={},this.options={apiHost:null,apiNamespace:"api/4/",apiToken:null,client:"https://cdn.socket.io/socket.io-1.2.1.js",server:null,reconnection:!0,reconnectionAttempts:1/0,reconnectionDelay:1e3,reconnectionDelayMax:6e4,pullInterval:1e4,pullIntervalEnhance:6e4,forceNew:!0},this.setOptions(e)},setOptions:function(t){this.options=e.extend({},this.options,t)},getIOClient:function(){var t=this,n=e.Deferred();return window.io||this.io?n.resolve(window.io||this.io):"function"==typeof require&&"function"==typeof define&&"object"==typeof define.amd?require([this.options.client],n.resolve,n.reject):e.ajax({url:this.options.client,dataType:"script",timeout:5e3}).always(function(){n[window.io?"resolve":"reject"](window.io)}),n.promise().done(function(e){t.io=e})},connect:function(){switch(this.states.push){case"connected":return e.Deferred().resolve().promise();case"connecting":return this.getPromise("push:connecting").promise()}var t=this,n=e.Deferred();return this.getIOClient().done(function(e){t.setState("push","connecting"),t.storePromise("push:connecting",n),t.socket=e(t.options.server,t.options),t.bindSocketEvents()}).fail(function(){t.setState("polling","connecting"),t.storePromise("polling:connecting",n)}).always(function(){t.join(t.offlineContext),t.offlineContext=null}),n.promise()},disconnect:function(){if("offline"===this.getState())return e.Deferred().resolve().promise();if("disconnecting"===this.states.push)return this.getPromise("push:disconnecting").promise();var t=this,n=e.Deferred();return this.socket?(this.setState("push","disconnecting"),this.storePromise("push:disconnecting",n),this.socket.disconnect()):n.resolve(),this.stopPolling(),this.offlineContext=null,n.promise().always(function(){t.setStates({push:"offline",polling:"offline"}),t.socket=null,t.rooms=[],t.analytics=[],t.promises={}})},joinFromPush:function(t){var n=this,i=e.Deferred();return this.socket?this.socket.emit("join",e.extend({token:this.options.apiToken},t),function(e,s){e?(console.log("[realtime] Unable to join rooms on the Wisembly websocket server",e,t),n.setState("polling","full"),i.reject()):(console.log("[realtime] Successfully joined %d rooms on the Wisembly websocket server",s.length,s),n.setState("polling","medium"),n.rooms=s,i.resolve(n.rooms))}):i.reject(),i.promise()},joinFromAPI:function(t){var n=this,i=e.Deferred();return this.fetchRooms({data:JSON.stringify(t)}).done(function(t,s,o){t=t.success||t,t=t.data||t,e.each(t.rooms,function(t,i){-1===e.inArray(i,n.rooms)&&n.rooms.push(i)}),n.setState("polling","full"),n.resolvePromise("polling:connecting"),n.lastPullTime=n.lastPullTime||+new Date(o.getResponseHeader("Date")),console.log("[realtime] Successfully retrieved %d rooms from Wisembly API",n.rooms.length,n.rooms),i.resolve(n.rooms)}).fail(i.reject),i.promise()},join:function(t){var n=this,i=e.Deferred();switch(this.getState()){case"push:connected":this.joinFromPush(t).fail(function(){n.joinFromAPI(t).done(i.resolve).fail(i.reject).always(function(){n.startRejoin(0)})});break;case"push:connecting":this.getPromise("push:connecting").done(function(){n.join(t).done(i.resolve).fail(i.reject)});break;case"polling:connecting":case"polling:full":this.joinFromAPI(t).done(i.resolve).fail(i.reject);break;default:this.offlineContext=e.extend({},this.offlineContext,t),i.reject()}return i.promise()},leave:function(){return e.Deferred().reject().promise()},startRejoin:function(t){if("connected"===this.states.push){var n=this;t=t||0,t=Math.min(t,this.options.reconnectionDelayMax),clearTimeout(this.rejoinTimer),this.rejoinTimer=setTimeout(function(){var i=n.rooms.length?n.joinFromPush({rooms:n.rooms}):e.Deferred().resolve().promise();i.done(function(){n.addAnalytics(n.analytics)}).fail(function(){n.startRejoin(t+n.options.reconnectionDelay)})},t)}},stopRejoin:function(){clearTimeout(this.rejoinTimer),this.rejoinTimer=null,this.rejoinTimeout=0},addAnalytics:function(t){t=!t||e.isArray(t)?t:[t];var n=this,i=e.Deferred();switch(this.getState()){case"push:connected":this.socket.emit("analytics:subscribe",t||[],function(e,t){e?i.reject():(console.log("[realtime] Successfully joined %d analytics rooms on the Wisembly websocket server",t.length),n.analytics=t,i.resolve(n.analytics))});break;default:e.each(t||[],function(t,i){-1===e.inArray(i,n.analytics)&&n.analytics.push(i)}),i.resolve(this.analytics)}return i.promise()},removeAnalytics:function(){return e.Deferred().reject().promise()},addEvent:function(e){this.events[e.hash]=!0},removeEvents:function(){this.events={}},checkEvent:function(e){return!this.events.hasOwnProperty(e.hash)},handleEvent:function(e){return this.checkEvent(e)&&this.checkEntity(e)?(this.addEvent(e),this.addEntity(e),this.sendEvent(e),!0):!1},sendEvent:function(e){this.trigger("event:received",e)},addEntity:function(e){var t=e.data||{},n=t.class_name||"",i=t.hash||"",s=n+i,o=e.time;s&&o&&(this.entities[s]=o)},checkEntity:function(e){var t=e.data||{},n=t.class_name||"",i=t.hash||"",s=n+i,o=e.time;return!s||!o||!this.entities.hasOwnProperty(s)||o>=this.entities[s]},startPolling:function(){var e=this,t=null;switch(this.states.polling){case"full":t=this.options.pullInterval;break;case"medium":t=this.options.pullIntervalEnhance;break;default:return}clearTimeout(this.pullTimer),this.pullTimer=setTimeout(function(){e.pull().always(function(){e.startPolling()})},t)},stopPolling:function(){clearTimeout(this.pullTimer),this.pullTimer=null,this.setState("polling","offline")},pull:function(){if(this.pullXHR)return this.pullXHR;var t=this;return this.pullXHR=this.fetchPullEvents(),this.pullXHR.done(function(n){n=n.success||n,n=n.data||n;var i=0;switch(e.each(n.data||[],function(n,s){i+=t.handleEvent(e.extend({},s,{via:"polling"}))?1:0}),t.getState()){case"polling:full":break;case"push:connected":case"push:connecting":t.setState("polling","medium"),i&&console.warn("[realtime] missed_push_event:"+i+": on "+n.data.length+" events");break;default:t.setState("polling","full")}t.lastPullTime=n.since>(t.lastPullTime||0)?n.since:t.lastPullTime}).fail(function(){t.setState("polling","medium")}).always(function(){t.pullXHR=null})},bindSocketEvents:function(){var e=this;this.socket.on("broadcast",function(){e.onBroadcast.apply(e,arguments)}),this.socket.on("connect",function(){console.log("[realtime] Welcome to the Wisembly websocket server"),e.onConnect.apply(e,arguments)}),this.socket.on("connect_error",function(){console.log("[realtime] Cannot connect to websocket server"),e.onConnectError.apply(e,arguments)}),this.socket.on("disconnect",function(){console.log("[realtime] Disconnected from the Wisembly websocket server"),e.onDisconnect.apply(e,arguments)}),this.socket.on("reconnecting",function(){console.log("[realtime] Reconnecting to the Wisembly websocket server"),e.onReconnecting.apply(e,arguments)}),this.socket.on("reconnect",function(){console.log("[realtime] Reconnected to the Wisembly websocket server"),e.onReconnect.apply(e,arguments)}),this.socket.on("analytics",function(t){t=t||{},e.onAnalytics.apply(e,arguments)})},onBroadcast:function(t){var t=JSON.parse(t);this.handleEvent(e.extend({},t,{via:"socket"}))},onConnect:function(){this.setStates({push:"connected",polling:"medium"}),this.resolvePromise("push:connecting")},onConnectError:function(){this.onDisconnect(),this.resolvePromise("push:connecting")},onDisconnect:function(){var e=this;this.resolvePromise("push:disconnecting").fail(function(){e.setStates({push:"offline",polling:"full"})})},onReconnecting:function(){this.setState("push","connecting")},onReconnect:function(){this.onConnect()},onAnalytics:function(e){this.trigger("analytics:update",e)},buildURL:function(e){if(!this.options.apiHost||!this.options.apiNamespace)return null;var t=this.options.apiHost+"/"+this.options.apiNamespace+"/"+e;return t.replace(/([^:]\/)\//g,function(e,t){return t})},fetchRooms:function(t){var n=this.buildURL("users/node/credentials?token="+this.options.apiToken);return n?e.ajax(e.extend(!0,{url:n,type:"POST",dataType:"json",contentType:"application/json",cache:!1},t)):e.Deferred().reject().promise()},fetchPullEvents:function(t){var n=this.buildURL("pull");return n&&this.rooms.length?e.ajax(e.extend(!0,{url:n,type:"GET",dataType:"json",contentType:"application/json",data:{token:this.options.apiToken,rooms:this.rooms,since:this.lastPullTime},cache:!1},t)):e.Deferred().reject().promise()},storePromise:function(e,t){return this.promises[e]=t},getPromise:function(t){return this.promises[t]||e.Deferred().reject()},resolvePromise:function(e){var t=this,n=this.getPromise(e);return"pending"===n.state()&&n.resolve(),n.promise().always(function(){delete t.promises[e]})},setStates:function(e){if(e.push!==this.states.push||e.polling!==this.states.polling){var t=this.states;this.states=e;var n=this.getState();this.state!==n&&(this.state=n,this.trigger("state:update",{state:n})),t.polling!==this.states.polling&&this.startPolling(),t.push!==this.states.push&&this.startRejoin(0)}},setState:function(e,t){var n={push:this.states.push,polling:this.states.polling};n[e]=t,this.setStates(n)},getState:function(){switch(this.states.polling){case"full":case"connecting":return"polling:"+this.states.polling}switch(this.states.push){case"connected":case"connecting":return"push:"+this.states.push}return"offline"},on:function(e,t){this.__bindings.hasOwnProperty(e)?this.__bindings[e].push(t):this.__bindings[e]=[t]},off:function(t,n){if(this.__bindings.hasOwnProperty(t)){var i=e.inArray(n,this.__bindings[t]);-1!==i&&this.__bindings[t].splice(i,1)}},trigger:function(e){if(this.__bindings.hasOwnProperty(e))for(var t=this.__bindings[e],n=Array.prototype.slice.call(arguments,1),i=0;i<t.length;i++)t[i].apply(null,n)}}}(jQuery);